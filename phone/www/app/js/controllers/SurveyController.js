/**
 *
 * @author Schubert Generated Code</br>
 * Date Created: </br>
 * @since  </br>
   build:   </p>
 *
 * code was generated by the Schubert System </br>
 * Schubert system Copyright - NewPortBay LLC copy_right_range</br>
 * The generated code is free to use by anyone</p>
 *
 *
 *
*/

app.controller('SurveyCtrl', [ '$scope', '$rootScope', '$location', '$window', '$q', '$http','surveyFactory','$cordovaSQLite','$timeout','$state','surveyService','$ionicPopup',function( $scope, $rootScope, $location, $window, $q, $http,surveyFactory,$cordovaSQLite,$timeout,$state,surveyService,$ionicPopup) {

		var self = $scope;
		$scope.surveyId = ''; 
		self.surveyFactory =[];
		self.surveyResult =[];
		$scope.surveyId = '';

		$scope.cameraUrl= '';
		//$scope.question = [{The_question: 'Loading..'}]
		$scope.imageURL = '';
			$scope.questionare ={
			answer:"",
			radioanswer:""
			};
			
		$scope.takePicture = function(){
			var cameraSuccess = function(imageData){
				 var image = document.getElementById('myImage');
				 image.src = imageData;
				 imageURL = "data:image/jpeg;charset=utf-8;base64," + imageData;

				// alert(imageData);
				$scope.cameraUrl=imageData;
				console.log("Image data ==>"+imageData)				
			};
			var cameraError = function(){
				 // load some default image here
			};
		navigator.camera.getPicture(cameraSuccess, cameraError);
		//cameraSuccess();
		};






		
		$scope.plain = false;
		$scope.isoption = false;
		$scope.yes_no = false;
		$scope.imageoption = false;
		$scope.camera = false;
		
		
	$scope.getNextQuestion=function(){
		console.log("-------------$scope.options=="+angular.toJson($scope.options));
		$scope.questionare.answer="";
		if($scope.options!= undefined && $scope.options.length > 0){
			var answer = "";
			var selectedoption = 0;
			var type= $scope.options[0].answer_type;
			if(type=='PLAIN_TEXT'){
				answer = $scope.questionare.answer;					
			}else if(type=='OPTION_LABEL'){
				selectedoption = $scope.questionare.radioanswer;
				answer ="";
			}else if(type=='YES_NO_CANCEL'){
				selectedoption = $scope.questionare.radioanswer;
				answer="";
			}else if(type=='IMAGE_OPTIONS'){
				selectedoption = $scope.questionare.radioanswer;
				answer ="";
			}else if($scope.options[0].answer_type=='CAMERA'){
					//$scope.camera = true;
					answer = $scope.cameraUrl;
			}else{
				alert('nothing selected');
			}

			var userid=1;
			//var surveyid = $rootScope.surveyId;		
			$scope.surveyId = $rootScope.surveyId;
			var insert_question_query ="";
			var result = "";
			var id=0;
			
			var selectmaxq = "SELECT  *  from survey_results  where  Id = (select max(Id) FROM survey_results) ";
			result = surveyFactory.execute($rootScope.db,selectmaxq,[]);	
			result.then(
			  function(res) {
				if(res.rows.length > 0) {
					id  = res.rows.item(0).Id;
					}
				insert_question_query="INSERT INTO survey_results VALUES(?,?,?,?,?,?,?,?,?)";							
				result = surveyFactory.execute($rootScope.db,insert_question_query,[id+1,$scope.question.Id,selectedoption,1,1,1,1,1,answer]);	
				result.then(
				  function(res) {
				//alert("result"+res);
				$scope.plain = false;
				$scope.isoption = false;
				$scope.yes_no = false;
				$scope.imageoption = false;
				$scope.camera = false;
				//alert(surveyFactory.getNextquestionId());
				$scope.options=[];
console.log("-------------surveyFactory.getNextquestionId()=="+angular.toJson(surveyFactory.getNextquestionId()));
					surveyService.getNextQuestion($scope.surveyId,surveyFactory.getNextquestionId());			
					$scope.question = surveyFactory.getQuestion();			
					$scope.options = surveyFactory.getQuestionOptions();
					if($scope.options.length>0){
						if($scope.options[0].answer_type=='PLAIN_TEXT'){
							$scope.plain = true;	
						}else if($scope.options[0].answer_type=='OPTION_LABEL'){
							$scope.isoption = true;
						}else if($scope.options[0].answer_type=='YES_NO_CANCEL'){
							$scope.yes_no = true;
						}else if($scope.options[0].answer_type=='IMAGE_OPTIONS'){
							$scope.imageoption = true;
						}else if($scope.options[0].answer_type=='CAMERA'){
							$scope.camera = true;							
						}else{
						$scope.plain = false;
						$scope.isoption = false;
						$scope.yes_no = false;
						$scope.imageoption = false;
						$scope.camera = false;
						}
					}
			         
					if(surveyFactory.getisEnd()==true){					
						$scope.isEnd = true;						
						$scope.showAlert('Thank You for Attending the survey!');						
						$timeout(function(){
							$state.transitionTo("begin-survey", {}, {
								reload: true,
								inherit: false,
								notify: true
							});
						},200);
					}else{
						$scope.isEnd = false;
					}
				console.log("Values added in survey results table "+result);
				});		
			  });
		}else{	
				$scope.plain = false;
				$scope.isoption = false;
				$scope.yes_no = false;
				$scope.imageoption = false;
				$scope.options=[];
				surveyService.getNextQuestion($scope.surveyId,surveyFactory.getNextquestionId());			
				$scope.question = surveyFactory.getQuestion();			
				$scope.options = surveyFactory.getQuestionOptions();
				if($scope.options.length>0){
					if($scope.options[0].answer_type=='PLAIN_TEXT'){
						$scope.plain = true;	
					}else if($scope.options[0].answer_type=='OPTION_LABEL'){
						$scope.isoption = true;
					}else if($scope.options[0].answer_type=='YES_NO_CANCEL'){
						$scope.yes_no = true;
					}else if($scope.options[0].answer_type=='IMAGE_OPTIONS'){
						$scope.imageoption = true;
					}else if($scope.options[0].answer_type=='CAMERA'){
					$scope.camera = true;
					}else{
					$scope.plain = false;
					$scope.isoption = false;
					$scope.yes_no = false;
					$scope.imageoption = false;
					$scope.camera = false;
					}
				}
				if(surveyFactory.getisEnd()==true){
					$scope.isEnd = true;
					
					$scope.showAlert('Thank You for Attending the survey!');
					$timeout(function(){				
						surveyFactory.setNextquestionId(0);
					$state.transitionTo("store-details", {}, {
						reload: true,
						inherit: false,
						notify: true
					});
					},200);
				
				}else{
					$scope.isEnd = false;
				}
				console.log("nextquestion..........."+ $scope.options);		
			}
		
		}
		
		$scope.showAlert = function (msg) {
            var alertPopup = $ionicPopup.alert({
                title: 'Result: ',
                template: msg
            });
            alertPopup.then(function (res) {
                console.log('Thanks');
            });
        };
		
	function firstQuestionWithOptions(){
		return $q(function(resolve, reject) {		
			$scope.plain = false;
			$scope.isoption = false;
			$scope.yes_no = false;
			$scope.imageoption = false;
			var quest_id = surveyFactory.getNextquestionId();
			console.log("survey Id-----------------------------------"+$scope.surveyId);
				var promise = surveyService.getNextQuestion($scope.surveyId,surveyFactory.getNextquestionId());	
				promise.then(function() {				
				//alert("inside firstQuestionWithOptions "+$scope.question+"option  "+$scope.options);				
				$scope.question = surveyFactory.getQuestion();	
				console.log("questions ------"+angular.toJson($scope.question));
				$scope.options = surveyFactory.getQuestionOptions();
				console.log("options ------"+angular.toJson($scope.question));
				  resolve($scope.options);
				if($scope.options.length>0){
					if($scope.options[0].answer_type=='PLAIN_TEXT'){
						$scope.plain = true;	
					}else if($scope.options[0].answer_type=='OPTION_LABEL'){
						$scope.isoption = true;
					}else if($scope.options[0].answer_type=='YES_NO_CANCEL'){
						$scope.yes_no = true;
					}else if($scope.options[0].answer_type=='IMAGE_OPTIONS'){
						$scope.imageoption = true;
					}else if($scope.options[0].answer_type=='CAMERA'){
					$scope.camera = true;
					}else{
					$scope.plain = false;
					$scope.isoption = false;
					$scope.yes_no = false;
					$scope.imageoption = false;
					$scope.camera = false;
					}
				}else{
					reject();
				}
				});
			});
		}
		 
        
		$scope.init=function(){
			console.log("-----init fun");
			if(surveyFactory.getisEnd()==true){
				$window.location.reload(true);
				surveyFactory.setisEnd(false);
				surveyFactory.setNextquestionId(0);
				surveyFactory.setQuestion('{}');
			}
				 firstQuestionWithOptions().then(function(res) {					
					console.log("---oprtino in promise--"+angular.toJson(res));
					//alert('Success promice: '+surveyFactory.getNextquestionId()+"options inside init"+angular.toJson(surveyFactory.getQuestionOptions()));
			}, function(reason) {
				alert('Failed: ' + reason);
			});
//				$scope.getNextQuestion();	
//$timeout(function(){   
		/*	surveyService.getSurvey().then(function(res){
				self.surveyResult = res;
				console.log("---A-"+angular.toJson(self.surveyResult));
			});*/
//			$timeout(function(){  console.log('----time  consumed'); },1500);
			//console.log("---A-"+angular.toJson(self.surveyResult));
//		},900);	
	}
		$scope.init();
}]);